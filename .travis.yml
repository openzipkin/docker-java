# update docker and enable squash similar to https://github.com/Dalee/build.docker/blob/master/.travis.yml
language: bash
sudo: required

services:
  - docker

before_script:
  # Ensure buildx is available and can build multi-architecture
  - |
    # Enable experimental features as buildx is still experimental
    export DOCKER_CLI_EXPERIMENTAL=enabled
    echo '{"experimental":true}' | sudo tee /etc/docker/daemon.json
    sudo service docker restart
    # Enable execution of different multi-architecture containers by QEMU and binfmt_misc
    # See https://github.com/multiarch/qemu-user-static
    docker run --rm --privileged multiarch/qemu-user-static --reset -p yes
    docker buildx create --name builder --use
  - |
    # Credentials entered into https://travis-ci.org/github/openzipkin/${REPO}/settings are access
    # controlled by branch (typically only master). Check to see if a well-known env is available
    # before attempting to log in.
    if [[ -n "$GH_USER" ]]; then
      # Log in to Docker Hub for releasing the image
      echo "$GH_TOKEN"| docker login ghcr.io -u "$GH_USER" --password-stdin
    fi

script: ./release.sh $TRAVIS_TAG

# Run only for tags as "on: tags: true" will still build master!
# Heuristic: tags describe versions, so they'll start with a number
branches:
  only:
    - /^[0-9]/

notifications:
  webhooks:
    urls:
      - https://webhooks.gitter.im/e/ead3c37d57527214e9f2
      - https://webhooks.gitter.im/e/9f1ee2f315d32956f8d6
    on_success: change
    on_failure: always

# When Travis, add to https://travis-ci.org/github/openzipkin/${REPO}/settings
#
# GH_TOKEN=XXX-https://github.com/settings/tokens-XXX
#   - makes release commits and tags, also writes to GHCR if Docker
#   - needs repo:status, public_repo and if Docker write:packages, delete:packages
#   - referenced in .settings.xml
#   - store like this: echo "https://$GH_TOKEN:@github.com" > .git/credentials
# GH_USER=user_that_created_GH_TOKEN