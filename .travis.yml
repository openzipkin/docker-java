# Run `travis lint` when changing this file to avoid breaking the build.

# We need a full VM so that testcontainers can use Docker
# See https://docs.travis-ci.com/user/reference/overview/#for-a-particular-travisyml-configuration
arch: amd64           # arm64 is LXD containers which we can't use because we run Docker tests
os: linux             # required for arch different than amd64
dist: focal           # newest available distribution

language: bash

services:
  - docker

before_install:
  # Ensure Docker buildx is available and can build multi-architecture
  - |
    # Enable experimental features on the server (multi-arch)
    echo '{"experimental":"enabled"}' > sudo tee /etc/docker/daemon.json
    # Enable experimental client features (eg docker buildx)
    mkdir -p $HOME/.docker && echo '{"experimental":"enabled"}' > $HOME/.docker/config.json
  - |
    # Add buildx plugin
    BUILDX_VERSION=0.4.2
    BUILDX_URL=https://github.com/docker/buildx/releases/download/v${BUILDX_VERSION}/buildx-v${BUILDX_VERSION}.linux-${TRAVIS_CPU_ARCH}
    mkdir -p $HOME/.docker/cli-plugins
    ( cd $HOME/.docker/cli-plugins && wget -qO- $BUILDX_URL > docker-buildx && chmod 755 docker-buildx)
  - |
    # Enable execution of different multi-architecture containers by QEMU and binfmt_misc
    # See https://github.com/multiarch/qemu-user-static
    docker run --rm --privileged multiarch/qemu-user-static --reset -p yes
    docker buildx create --name builder --use
  - |
    # Credentials entered into https://travis-ci.org/github/openzipkin/${REPO}/settings are access
    # controlled by branch (typically only master). Check to see if a well-known env is available
    # before attempting to log in.
    if [[ -n "$GH_USER" ]]; then
      # Log in to Docker Hub for releasing the image
      echo "$GH_TOKEN"| docker login ghcr.io -u "$GH_USER" --password-stdin
    fi

script: ./release.sh $TRAVIS_TAG

# Run only for tags as "on: tags: true" will still build master!
# Heuristic: tags describe versions, so they'll start with a number
branches:
  only:
    - /^[0-9]/

notifications:
  webhooks:
    urls:
      - https://webhooks.gitter.im/e/ead3c37d57527214e9f2
      - https://webhooks.gitter.im/e/9f1ee2f315d32956f8d6
    on_success: change
    on_failure: always

# When Travis, add to https://travis-ci.org/github/openzipkin/${REPO}/settings
#
# GH_TOKEN=XXX-https://github.com/settings/tokens-XXX
#   - makes release commits and tags, also writes to GHCR if Docker
#   - needs repo:status, public_repo and if Docker write:packages, delete:packages
#   - referenced in .settings.xml
#   - store like this: echo "https://$GH_TOKEN:@github.com" > .git/credentials
# GH_USER=user_that_created_GH_TOKEN